#!/usr/bin/env python

"""
Visualize shallow water simulation results.

NB: Requires a modern Matplotlib version; also needs
 either FFMPeg (for MP4) or ImageMagick (for GIF)
"""
import os
import numpy as np
import matplotlib
matplotlib.use('Agg')
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
import matplotlib.animation as manimation
import sys


def main(datadir, outfile="wave.gif"):
    """Visualize shallow water simulation results.

    Args:
        infile: Name of input file generated by simulator
        outfile: Desired output file (mp4 or gif)
        startpic: Name of picture generated at first frame
    """
    files = os.listdir(datadir)
    nframe = len(files)
    tframe = np.loadtxt("%s/data0" % datadir)
    m = tframe.shape[0]
    X, Y = np.meshgrid(np.linspace(-1, 1, m), np.linspace(-1, 1, m), indexing='ij')
    fig = plt.figure(figsize=(10,10))

    def plot_frame(filename):
        ax = fig.add_subplot(111, projection='3d')
        ax.set_zlim(0, 2)
        H = np.loadtxt(filename)
        ax.plot_surface(X, Y, H, color='w', rstride=5, cstride=5)
        return ax

    metadata = dict(title='Wave animation', artist='Matplotlib')
    if outfile[-4:] == ".mp4":
#        Writer = manimation.writers['ffmpeg']
        Writer = manimation.writers['avconv']
        writer = Writer(fps=15, metadata=metadata,
                        extra_args=["-r", "30",
                                    "-c:v", "libx264",
                                    "-pix_fmt", "yuv420p"])
    elif outfile[-4:] == ".gif":
        Writer = manimation.writers['imagemagick']
        writer = Writer(fps=15, metadata=metadata)

    with writer.saving(fig, outfile, nframe):
        for i in range(0, nframe):
            print "plot frame", i
            ax = plot_frame("%s/data%d" % (datadir, i))
            writer.grab_frame()
            plt.delaxes(ax)


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print "Usage: python gen_gif.py <dir>"
        exit(1)
    main(sys.argv[1])
